# PlainTest Implementation for PAN Validation API

This reference shows how to exercise the CVL-KRA PAN validation API using the PlainTest CLI. The project is organised so Postman collections live under `collections/raw/`, Postman scripts sit in `scripts/`, and runnable copies are generated automatically using `plaintest scripts sync`.

## Layout

```
reference/cvl-kra/
├── collections/
│   ├── raw/                     # Postman exports (source of truth)
│   └── build/                   # Generated collections used for execution
├── data/                        # CSV test data
├── environments/                # Environment configurations (templates provided)
├── ops/                         # Utility scripts (start/stop local stack)
├── reports/                     # Newman reports generated by the runner
├── scripts/                     # Postman scripts extracted from collections
├── run-plaintest.sh             # Convenience wrapper around the PlainTest CLI
└── requirements.md              # Domain-specific requirements
```

## Collections

- **`get_password`** – Phase 1 collection that fetches session credentials and exports them to a temporary environment.
- **`pan_validation_tests`** – Phase 2 CSV-driven suite (97 iterations) that validates XML responses.
- **`pan_validation_smoke`** – Small smoke suite that exercises critical happy-path scenarios.

## Preparing the Project

1. Ensure you have the PlainTest binary available (from the repository root):
   ```bash
   make build
   ```

2. Install Newman and reporter dependencies:
   ```bash
   npm install -g newman newman-reporter-htmlextra
   ```

3. Copy one of the environment templates and populate credentials:
   ```bash
   cp environments/localhost.postman_environment.json.template environments/localhost.postman_environment.json
   cp environments/uat.postman_environment.json.template environments/uat.postman_environment.json
   ```

4. Sync collections into script files and runnable copies:
   ```bash
   ../../plaintest scripts sync --check
   ```
   The `--check` flag executes the smoke collection through Newman to confirm the scripts are valid in the Postman sandbox.

## Running Tests

The helper script wraps the PlainTest CLI so you do not have to remember the full command line. Examples below assume you run from `reference/cvl-kra/`.

- **Smoke suite:**
  ```bash
  ./run-plaintest.sh -t smoke -e localhost
  ./run-plaintest.sh -t smoke -e uat
  ```

- **Full CSV suite:**
  ```bash
  ./run-plaintest.sh -t full -e localhost
  ./run-plaintest.sh -t full -e uat
  ```

- **Row selection:**
  ```bash
  ./run-plaintest.sh -t full -e localhost -r 2-5
  ./run-plaintest.sh -t full -e localhost -r 1,3,5
  ```

- **Iteration limit / debug output:**
  ```bash
  ./run-plaintest.sh -t full -e localhost -n 1
  ./run-plaintest.sh -t full -e localhost -d
  ```

The script simply delegates to:
```bash
../../plaintest run get_password pan_validation_tests -e environments/<env>.postman_environment.json -d data/pan_validation_plaintest.csv
```
and uses the `-r` flag for row selection.

## CSV Structure

The CSV follows the PlainTest META → INPUT → EXPECTED pattern:

- **META**: `test_id`, `test_scenario`, `test_description`, `test_endpoint`, `test_method`, `test_result`, `test_comments`
- **INPUT**: `input_pan_no`, `input_dob`, `input_iop_flag`, `input_pos_code`, `input_okra_code`, `input_okra_batch`, `input_request_date`, `input_total_records`
- **EXPECTED**: `expected_http_status`, `expected_app_status`

## Notes

- `scripts/` contains the inlined Postman scripts extracted by `plaintest scripts sync`. Edit those files to change test behaviour and re-run sync.
- `collections/build/` is regenerated on every sync; do not edit those files manually.
- Local environment helpers remain in `ops/start-app.sh` and `ops/stop-app.sh` for teams that need to manage supporting services.
